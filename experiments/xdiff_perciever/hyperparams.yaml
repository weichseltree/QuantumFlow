default: &default
  seed: 0

  dataset_train: &default-dataset_train
    class: quantumflow.noninteracting_1d.DensityKineticEnergyDataset
    experiment: snyder_2012
    run_name: recreate_dataset
    N: 2
    dtype: float32
    subtract_von_weizsaecker: True

    features: 
      - density

    targets: 
      - kinetic_energy
      - kinetic_energy_density
      #- derivative

  dataset_validate:
    <<: *default-dataset_train
    run_name: validate_dataset
    max_batch_size: 1

  model: &default-model
    class: quantumflow.xdiff.XdiffPerciever_KineticEnergyDensityFunctional
    num_layers: 1
    num_repeats: 8
    d_model: 64
    d_cross: 64
    dff_input: [64, 128]
    dff: 128
    dff_final: [128, 64]
    num_heads: 8
    dropout_rate: 0.0
    scale: 1.0
    latents_per_x: 1
    K: 10


  metrics: 
    kinetic_energy: mean_absolute_error
    kinetic_energy_density: mean_absolute_error
    #derivative: mean_absolute_error

  loss: 
    kinetic_energy: mean_squared_error
    kinetic_energy_density: mean_squared_error
    #derivative: mean_squared_error

  loss_weights:
    kinetic_energy: 0
    kinetic_energy_density: 1.0
    #derivative: 1.0

  optimizer: &default-optimizer
    class: quantumflow.utils.Adam
    beta_1: 0.9
    beta_2: 0.999
    epsilon: 1e-07
    amsgrad: False

    clipnorm: 100.0

    learning_rate: &default-optimizer-learning_rate
      class: quantumflow.utils.WarmupExponentialDecay
      initial_learning_rate: 0.000025
      final_learning_rate: 0.0000000001
      decay_rate: 0.9
      decay_steps: 1000 # batches

      cold_steps: 21800 # batches
      warmup_steps: 0 # batches
      cold_factor: 1.0

  fit: &default-fit
    batch_size: 1
    epochs: 1000
    verbose: 0
    #validation_split: 0.1
    validation_freq: 100  # epochs
    shuffle: True
    initial_epoch: 0

  checkpoint: &default-checkpoint
    filename: weights.{epoch:03d}.tf
    save_freq: 20000 # batches
    save_weights_only: True

  tensorboard: &default-tensorboard
    class: quantumflow.utils.CustomTensorBoard
    histogram_freq: 100 # epochs
    metrics_freq: 1 # epochs
    write_graph: True
    write_images: True
    update_freq: epoch
    profile_batch: [10, 20]

  save: True


derivative: 
  <<: *default
  
  dataset_train: &derivative-dataset_train
    <<: *default-dataset_train
    targets: 
      - kinetic_energy
      - kinetic_energy_density
      - derivative
      
  dataset_validate:
    <<: *derivative-dataset_train
    run_name: validate_dataset

  model:
    class: quantumflow.noninteracting_1d.KineticEnergyFunctionalDerivativeModel
    base_model:
      <<: *default-model
      
  metrics: 
    kinetic_energy: mean_absolute_error
    kinetic_energy_density: mean_absolute_error
    derivative: mean_absolute_error

  loss: 
    kinetic_energy: mean_squared_error
    kinetic_energy_density: mean_squared_error
    derivative: mean_squared_error

  loss_weights:
    kinetic_energy: 0
    kinetic_energy_density: 1.0
    derivative: 1.0


latents:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    latents_per_x: 16
    
    
debug:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    latents_per_x: 1
    
    
debug_scaled:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    dff_input: []
  
  
debug_input:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
  
  
debug_new:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
  
  
debug_kernel:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 1
  
  
debug_kernel_fix:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
  
debug_x:
  <<: *default
  model: 
    <<: *default-model
    num_repeats: 16
    num_layers: 0
    
    d_model: 64
    d_cross: 32
    num_heads: 8
    
    dff_input: [64]
    dff: 64
    dff_final: [64]
    
    dropout_rate: 0.0
    scale: 1.0
    latents_per_x: 1
    
    
debug_x_new:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
    
    
debug_x_slim:
  <<: *default
  model: &debug_x_slim-model
    <<: *default-model
    num_repeats: 8
    num_layers: 0
    
    d_model: 32
    d_cross: 32
    num_heads: 8
    
    dff_input: [32]
    dff: 32
    dff_final: [32]
    
    dropout_rate: 0.0
    scale: 1.0
    latents_per_x: 1


debug_x_slim_deriv:
  <<: *default
 
  dataset_train: &debug_x_slim_deriv-dataset_train
    <<: *default-dataset_train
    targets: 
      - kinetic_energy
      - kinetic_energy_density
      - derivative
      
  dataset_validate:
    <<: *debug_x_slim_deriv-dataset_train
    run_name: validate_dataset

  model:
    class: quantumflow.noninteracting_1d.KineticEnergyFunctionalDerivativeModel
    base_model:
      <<: *debug_x_slim-model
      
  metrics: 
    kinetic_energy: mean_absolute_error
    kinetic_energy_density: mean_absolute_error
    derivative: mean_absolute_error

  loss: 
    kinetic_energy: mean_squared_error
    kinetic_energy_density: mean_squared_error
    derivative: mean_squared_error

  loss_weights:
    kinetic_energy: 0
    kinetic_energy_density: 1.0
    derivative: 1.0


debug_x_slim_batch:
  <<: *default
  model: 
    <<: *debug_x_slim-model
    
  fit: 
    <<: *default-fit
    batch_size: 5
    validation_freq: 500  # epochs

  tensorboard: 
    <<: *default-tensorboard
    class: quantumflow.utils.CustomTensorBoard
    histogram_freq: 500 # epochs
    metrics_freq: 5 # epochs
    

debug_x_token_new:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
    
    
debug_x_token_new_K:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
    K: 20


debug_x_slim_2:
  <<: *default
  model:
    <<: *default-model
    num_repeats: 6
    num_layers: 0
    
    d_model: 32
    d_cross: 32
    num_heads: 8
    
    dff_input: []
    dff: 32
    dff_final: []
    
    dropout_rate: 0.0
    scale: 1.0
    latents_per_x: 1
    

debug_inputs_new:
  <<: *default
  model: 
    <<: *default-model
    num_heads: 16
    d_cross: 32
    num_layers: 0
    

default_slim:
  <<: *default
  model:
    <<: *default-model
    num_repeats: 2
    num_layers: 0
    
    d_model: 32
    d_cross: 16
    num_heads: 8
    
    dff_input: []
    dff: 32
    dff_final: []
    
    dropout_rate: 0.0
    scale: 1.0
    latents_per_x: 1
    
  fit: 
    <<: *default-fit
    batch_size: 100
    epochs: 100000
    validation_freq: 10000  # epochs

  tensorboard: 
    <<: *default-tensorboard
    histogram_freq: 10000 # epochs
    metrics_freq: 100 # epochs0